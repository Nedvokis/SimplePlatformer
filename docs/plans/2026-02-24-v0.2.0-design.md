# Дизайн-документ v0.2.0

## Обзор

Версия v0.2.0 добавляет: счётчик смертей с HUD, экран победы после прохождения всех уровней, тестирование, логирование с файлом логов, Justfile для сборки, документацию по созданию уровней.

## 1. Счётчик смертей

### Ресурс

```rust
#[derive(Resource, Default)]
struct DeathCounter {
    current_level: usize,  // смерти на текущем уровне
    total: usize,          // сумма за все уровни
}
```

### Жизненный цикл

- Создаётся при входе на уровень (если ещё не существует)
- `current_level` обнуляется при входе на каждый уровень
- При прохождении уровня: `total += current_level`
- При выходе в главное меню — ресурс удаляется

### Инкремент

В существующих системах `check_spikes()` и `player_death()` (падение ниже y=-500) добавить `counter.current_level += 1`.

## 2. HUD

- Текст "Deaths: N" в верхнем левом углу экрана
- Спаунится вместе с уровнем (OnEnter Playing)
- Удаляется через DespawnOnExit
- Обновляется системой, следящей за изменением `current_level`

## 3. Экран победы

### Новое состояние

```rust
enum GameState {
    Menu,
    LevelSelect,
    LevelTransition,
    Playing,
    Paused,
    Settings,
    Victory,  // новое
}
```

### Переход

- В `check_exit()`: если текущий уровень == 5 (последний), переход в `Victory` вместо `LevelSelect`
- Перед переходом: `total += current_level`

### UI

- Текст "Congratulations!"
- Строка "You died: {total}" (с юмористическими комментариями для особых чисел, например "69 - nice")
- Кнопка "Main Menu" — переход в `Menu`
- Стилистика как у остальных экранов (те же цвета, шрифты, паттерн Button + Interaction)

### Плагин

Новый `VictoryPlugin` по аналогии с `MenuPlugin`:
- OnEnter Victory — спаун UI
- Система обработки кнопки
- DespawnOnExit(Victory) для cleanup
- При переходе в Menu — удалить ресурс DeathCounter

## 4. Логирование

### Точки логирования

Используем `bevy::log` (info/debug/error) — нулевые дополнительные зависимости:

- `load_level()` — info: загруженный уровень (имя, количество тайлов)
- `check_exit()` — info: прохождение уровня
- `check_spikes()` / `player_death()` — debug: смерть (тип: шипы или падение)
- `progress::save()` / `progress::load()` — info: успех, error: ошибка
- `DeathCounter` — debug: инкремент

### Файл логов

Ring buffer подход:

- Ресурс `LogBuffer` — кольцевой буфер на 50 записей (`VecDeque<String>`, max 50)
- Кастомный `tracing` Layer перехватывает события уровня info+ и пишет в буфер
- Файл: `~/.local/share/simple_platformer/game.log`
- Перезаписывается целиком (не append) — всегда последние 50 записей, ~5-10 КБ

### Стратегия flush

- Каждые 30 секунд (система в Update с таймером)
- Немедленно при `error!`
- При выходе из игры

### Формат записи

```
[2026-02-24 15:30:01] INFO  level: Loaded "The Beginning" (24 tiles)
[2026-02-24 15:30:05] DEBUG player: Death by spikes (deaths: 3)
[2026-02-24 15:30:05] ERROR progress: Failed to save: Permission denied
```

## 5. Тестирование

### Unit-тесты (в тех же файлах, `#[cfg(test)]`)

| Модуль | Что тестируем |
|--------|--------------|
| `level.rs` | Парсинг RON в LevelData, merge_platform_runs (соседние тайлы сливаются, разрывы — нет, шипы не сливаются) |
| `progress.rs` | Save/load roundtrip, загрузка при отсутствии файла (дефолт), загрузка битого JSON |

### Интеграционные тесты (Bevy mini-App)

| Модуль | Что тестируем |
|--------|--------------|
| `player.rs` | Спаун в правильной позиции, респаун при падении ниже -500, инкремент DeathCounter при смерти |
| `level.rs` | check_exit при коллизии с выходом — переход состояния, разблокировка уровня |
| `states.rs` | Переход Playing → Victory при прохождении уровня 5 |

Интеграционные тесты: `App::new()` с MinimalPlugins + нужные плагины, ручная вставка ресурсов/сущностей, `app.update()`, проверка результата.

## 6. Justfile

### Команды

| Команда | Что делает |
|---------|-----------|
| `just run` | `cargo run` |
| `just build` | `cargo build --release` |
| `just check` | `cargo check` |
| `just lint` | `cargo clippy` |
| `just test` | `cargo test` |
| `just clean` | `cargo clean` |
| `just package` | Release-сборка Linux + Windows (кросс-компиляция), упаковка в zip в `dist/` |

### Package

Результат `just package`:
- `dist/SimplePlatformer-v{VERSION}-linux-x86_64.zip`
- `dist/SimplePlatformer-v{VERSION}-windows-x86_64.zip`

Требования для кросс-компиляции (одноразовая настройка):
- `rustup target add x86_64-pc-windows-gnu`
- `sudo pacman -S mingw-w64-gcc`

## 7. Документация по созданию уровней

### Файл

`docs/LEVEL_CREATION_GUIDE.md` (на русском)

### Структура

1. **Введение** — что такое уровень, где лежат файлы (`assets/levels/level_NN.ron`)
2. **Формат RON** — структура LevelData: spawn, exit, tiles (Platform, Spikes)
3. **Система координат** — тайловые координаты (1 тайл = 32px), x вправо, y вверх
4. **Пошаговый пример** — создание минимального уровня с нуля, полный RON-файл
5. **Советы по левел-дизайну** — размеры gap для прыжков, шипы, вертикальность, тестирование
6. **Как добавить уровень в игру** — константа количества уровней, именование файла

## Новые сущности в коде

- Состояние `Victory` в `GameState`
- Ресурс `DeathCounter`
- Ресурс `LogBuffer` (ring buffer)
- Плагин `VictoryPlugin` (`src/victory.rs`)
- Файл `justfile` (корень проекта)
- Документ `docs/LEVEL_CREATION_GUIDE.md`
